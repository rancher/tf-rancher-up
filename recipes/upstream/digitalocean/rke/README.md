# Upstream | DigitalOcean | RKE

This module is used to establish a Rancher (local) managment cluster using DigitalOcean and RKE.

## Usage

```bash
git clone https://github.com/rancherlabs/tf-rancher-up.git
cd recipes/upstream/digitalocean/rke
```

- Copy `terraform.tfvars.example` to `terraform.tfvars`
- Edit `terraform.tfvars`
  - Update the required variables:
    -  `region` to suit your region
    -  `prefix` to give the resources an identifiable name (eg, your initials or first name)
- Store your DigitalOcean auth token as an environment variable: 
```bash
export TF_VAR_do_token=dop_v1_xxxxxxxxx
```
- Alternatively, you can uncomment `do_token` in `terraform.tfvars` and input the required auth token there.
- Modify the `ssh_key_name` variable to contain the name of a public ssh key stored in DigitalOcean and the `ssh_private_key_path` variable to contain the local path to it's private key.
- If an HA cluster need to be deployed, change the `instance_count` variable to 3 or more.
- Modify the `user_tag` variable so that it contains your first initial and last name.
- There are more optional variables which can be tweaked under `terraform.tfvars`.

**NOTE** you may need to use ` terraform init -upgrade` to upgrade provider versions

Execute the below commands to start deployment.

```bash
terraform init
terraform plan
terraform apply
```

The login details will be displayed in the screen once the deployment is successful. It will have the details as below.

```bash
rancher_hostname = "https://rancher.<xx.xx.xx.xx>.sslip.io"
rancher_password = "initial-admin-password"
```

- Destroy the resources when cluster is no more needed.
```bash
terraform destroy
```

**IMPORTANT**: Please retire the services which are deployed using these terraform modules within 48 hours. Soon there will be automation to retire the service automatically after 48 hours but till that is in place it will be the users responsibility to not keep it running more than 48 hours.

### Advanced

Target a specific resource/module to action the changes only for that resource/module

For example, target only the `rke_cluster` resource to re-run the equivalent of `rke up`

```bash
terraform apply -target module.rke.rke_cluster.this -target module.rke.local_file.kube_config_yaml
```

This also updates the kube_config generated by RKE.

### Notes

A log file for the RKE provisioning is written to `rke.log`

See full argument list for each module in use:
  - [DigitalOcean](../../../../modules/infra/digitalocean)
  - [RKE](../../../../modules/distribution/rke)
  - [Rancher](../../../../modules/rancher)

### Known Issues
- `terraform destroy` will timeout while removing the Rancher helm release from the cluster. You can run `terraform destroy` again after the timeout and the deprovisiong process will complete successfully.  

---

## Requirements

No requirements.

## Providers

No providers.

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_rancher_install"></a> [rancher\_install](#module\_rancher\_install) | ../../../../modules/rancher | n/a |
| <a name="module_rke"></a> [rke](#module\_rke) | ../../../../modules/distribution/rke | n/a |
| <a name="module_upstream-cluster"></a> [upstream-cluster](#module\_upstream-cluster) | ../../../../modules/infra/digitalocean | n/a |

## Resources

No resources.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_do_token"></a> [do\_token](#input\_do\_token) | DigitalOcean authentication token | `string` | `null` | yes |
| <a name="input_droplet_count"></a> [droplet\_count](#input\_droplet\_count) | Number of droplets to create | `number` | `3` | no |
| <a name="input_droplet_size"></a> [droplet\_size](#input\_droplet\_size) | Size used for all droplets | `string` | `s-2vcpu-4gb` | no |
| <a name="input_prefix"></a> [prefix](#input\_prefix) | Prefix added to the names of all resources | `string` | `rancher-terraform` | no |
| <a name="input_tag_begin"></a> [tag\_begin](#input\_tag\_begin) | Tag from this number when the module is called more than once | `number` | `1` | no |
| <a name="input_user_tag"></a> [user\_tag](#input\_user\_tag) | User tag in `FirstInitialLastName` format | `string` | `null` | yes |
| <a name="input_ssh_key_name"></a> [ssh\_key\_name](#input\_ssh\_key\_name) | Name of the public ssh key stored on DigitalOcean | `string` | `null` | no |
| <a name="input_ssh_private_key_path"></a> [ssh\_private\_key\_path](#input\_ssh\_private\_key\_path) | Local path to the private ssh key that matches the `ssh_key_name` stored on DigitalOcean | `string` | `null` | yes |
| <a name="input_region"></a> [region](#input\_region) | Region targeted for droplet deployment | `string` | `sfo3` | no |
| <a name="input_ssh_username"></a> [ssh\_username](#input\_ssh\_username) | The user account used to connect to droplets via ssh | `string` | `root` | no |
| <a name="input_kube_config_path"></a> [kube\_config\_path](#input\_kube\_config\_path) | Path to where the RKE cluster's kubeconfig will be stored | `string` | `null` | no |
| <a name="input_kubernetes_version"></a> [kubernetes\_version](#input\_kubernetes\_version) | Kubernetes version to use for the RKE cluster | `string` | `null` | no |
| <a name="input_rancher_password"></a> [rancher\_password](#input\_rancher\_password) | Password to use for bootstrapping Rancher (min 12 characters) | `string` | `"initial-admin-password"` | no |
| <a name="input_rancher_version"></a> [rancher\_version](#input\_rancher\_version) | Rancher version to install | `string` | `null` | no 
| <a name="input_wait"></a> [wait](#input\_wait) | An optional wait before installing the Rancher helm chart | `string` | `"20s"` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_droplets_private_ip"></a> [droplets\_private\_ip](#output\_droplets\_private\_ip) | n/a |
| <a name="output_droplets_public_ip"></a> [droplets\_public\_ip](#output\_droplets\_public\_ip) | n/a |
| <a name="output_rancher_hostname"></a> [rancher\_hostname](#output\_rancher\_hostname) | n/a |
| <a name="output_rancher_password"></a> [rancher\_password](#output\_rancher\_password) | n/a |